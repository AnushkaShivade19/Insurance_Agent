{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gramin Suraksha Mitra üí¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e3a8a; --user-msg-bg: #3b82f6; --bot-msg-bg: #e5e7eb;
            --bg-color: #f0f4f8; --font-family: 'Poppins', sans-serif;
        }
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-family); background-color: var(--bg-color); height: 100vh;
            display: flex; justify-content: center; align-items: center; margin: 0;
        }
        .chat-container {
            width: 100%; max-width: 450px; height: 90vh; max-height: 700px; background: #fff;
            border-radius: 20px; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden;
        }
        .header-controls {
            display: flex; justify-content: space-between; align-items: center; padding: 1rem;
            background: var(--primary-color); color: white; flex-shrink: 0;
        }
        .header-title { font-weight: 600; font-size: 1.1rem; }
        #language-selector {
            padding: 5px 8px; border-radius: 5px; border: 1px solid #fff;
            background: var(--primary-color); color: #fff; font-family: var(--font-family); cursor: pointer;
        }
        .chat-box {
            flex-grow: 1; padding: 1.25rem; overflow-y: auto; display: flex;
            flex-direction: column; gap: 1rem;
        }
        .message-row { display: flex; gap: 10px; align-items: flex-end; max-width: 90%; }
        .bot-message .message-row { align-self: flex-start; }
        .user-message .message-row { align-self: flex-end; flex-direction: row-reverse; }
        .avatar {
            width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 1.2rem; flex-shrink: 0;
        }
        .bot-avatar { background-color: var(--primary-color); color: #fff; }
        .message-content {
            padding: 10px 15px; border-radius: 18px; line-height: 1.5;
            animation: fadeIn 0.3s ease-out; word-wrap: break-word;
        }
        .user-message .message-content {
            background: var(--user-msg-bg); color: white; border-bottom-right-radius: 4px;
        }
        .bot-message .message-content {
            background: var(--bot-msg-bg); color: #1f2937; border-bottom-left-radius: 4px;
        }
        .input-area {
            display: flex; align-items: center; border-top: 1px solid #e5e7eb;
            background: #fff; padding: 0.75rem;
        }
        .input-area input {
            flex-grow: 1; padding: 12px; border: 2px solid transparent; border-radius: 99px;
            background: #f0f4f8; outline: none; font-size: 1rem; font-family: var(--font-family);
            transition: border-color 0.3s;
        }
        .input-area input:focus { border-color: var(--primary-color); }
        .input-area button {
            background: var(--primary-color); color: white; border: none; padding: 0 20px;
            margin-left: 8px; border-radius: 99px; cursor: pointer; transition: background-color 0.3s;
            font-weight: 500; font-size: 1rem; height: 48px;
        }
        .mic-button {
            background: transparent; border: none; font-size: 1.5rem; cursor: pointer;
            color: #555; padding: 0 10px; transition: color 0.3s, transform 0.2s;
        }
        .mic-button.is-listening { color: #e63946; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header-controls">
            <div class="header-title">
                Gramin Suraksha Mitra
                {% if user.is_authenticated %}
                    <span style="font-size: 0.8rem; font-weight: 400;">(Welcome, {{ user.username }})</span>
                {% endif %}
            </div>
            <div style="display: flex; align-items: center;">
                {% if user.is_authenticated %}
                    <a href="{% url 'logout' %}" style="color: white; margin-right: 15px; text-decoration: none;">Logout</a>
                {% else %}
                    <a href="{% url 'login' %}" style="color: white; margin-right: 15px; text-decoration: none;">Login</a>
                {% endif %}
                <select id="language-selector">
                    <option value="en-IN">English</option>
                    <option value="as-IN">‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ (Assamese)</option>
                    <option value="bn-IN">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                    <option value="brx">‡§¨‡•ã‡§°‡§º‡•ã (Bodo)</option>
                    <option value="doi">‡§°‡•ã‡§ó‡§∞‡•Ä (Dogri)</option>
                    <option value="gu-IN">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
                    <option value="hi-IN">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="kn-IN">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
                    <option value="ks-IN">‡§ï‡§∂‡•ç‡§Æ‡•Ä‡§∞‡•Ä (Kashmiri)</option>
                    <option value="kok-IN">‡§ï‡•ã‡§Ç‡§ï‡§£‡•Ä (Konkani)</option>
                    <option value="mai-IN">‡§Æ‡•à‡§•‡§ø‡§≤‡•Ä (Maithili)</option>
                    <option value="ml-IN">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)</option>
                    <option value="mni">‡¶Æ‡ßà‡¶§‡ßà‡¶≤‡ßã‡¶®‡ßç (Manipuri)</option>
                    <option value="mr-IN">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                    <option value="ne-IN">‡§®‡•á‡§™‡§æ‡§≤‡•Ä (Nepali)</option>
                    <option value="or-IN">‡¨ì‡¨°‡¨º‡¨ø‡¨Ü (Odia)</option>
                    <option value="pa-IN">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)</option>
                    <option value="sa-IN">‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç (Sanskrit)</option>
                    <option value="sat">·±•·±ü·±±·±õ·±ü·±≤·±§ (Santali)</option>
                    <option value="sd">‡§∏‡§ø‡§®‡•ç‡§ß‡•Ä (Sindhi)</option>
                    <option value="ta-IN">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                    <option value="te-IN">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                    <option value="ur-IN">ÿßÿ±ÿØŸà (Urdu)</option>
                </select>
            </div>
        </div>
        <div class="chat-box" id="chatBox"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Ask a question..." onkeypress="handleKeyPress(event)">
            <button id="mic-btn" class="mic-button">üé§</button>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
    <script>
        const chatBox = document.getElementById("chatBox"), userInput = document.getElementById("userInput");
        const languageSelector = document.getElementById("language-selector"), micBtn = document.getElementById("mic-btn");
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        const speechSynthesis = window.speechSynthesis;

        if (recognition) {
            recognition.continuous = false; recognition.lang = languageSelector.value; recognition.interimResults = false;
            recognition.onresult = (event) => { userInput.value = event.results[0][0].transcript; micBtn.classList.remove("is-listening"); sendMessage(); };
            recognition.onerror = (event) => { console.error("Speech recognition error:", event.error); micBtn.classList.remove("is-listening"); };
            recognition.onend = () => micBtn.classList.remove("is-listening");
            micBtn.addEventListener("click", () => {
                if (micBtn.classList.contains("is-listening")) { recognition.stop(); } 
                else { recognition.lang = languageSelector.value; recognition.start(); micBtn.classList.add("is-listening"); }
            });
        } else { micBtn.style.display = "none"; }

        function appendMessage(text, type) {
            const wrapper = document.createElement("div"); wrapper.className = type;
            const row = document.createElement("div"); row.className = "message-row";
            const content = document.createElement("div"); content.className = "message-content"; content.innerHTML = text;
            if (type === 'bot-message') {
                const avatar = document.createElement("div"); avatar.className = "avatar bot-avatar"; avatar.textContent = "ü§ñ";
                row.appendChild(avatar);
            }
            row.appendChild(content); wrapper.appendChild(row); chatBox.appendChild(wrapper); chatBox.scrollTop = chatBox.scrollHeight;
        }

        function speak(text, lang) {
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            const cleanText = text.replace(/\*\*/g, ''); // Remove markdown for voice
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = lang;
            speechSynthesis.speak(utterance);
        }

        async function sendMessage() {
            const text = userInput.value.trim(); if (!text) return;
            appendMessage(text, "user-message"); userInput.value = ""; appendMessage("...", "bot-message");
            try {
                const response = await fetch(`/get-response?userMessage=${encodeURIComponent(text)}`);
                const data = await response.json();
                chatBox.removeChild(chatBox.lastChild);
                appendMessage(data.botResponse, "bot-message");
                speak(data.botResponse, languageSelector.value);
            } catch (error) {
                chatBox.removeChild(chatBox.lastChild);
                appendMessage("‚ö†Ô∏è Sorry, something went wrong.", "bot-message");
            }
        }

        function setWelcomeMessage(lang) {
            const messages = {
                'en-IN': "Namaste! üôè Ask me to explain a term, or say 'find a policy' for a recommendation.",
                'hi-IN': "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! üôè ‡§Æ‡•Å‡§ù‡§∏‡•á ‡§ï‡•ã‡§à ‡§¨‡•Ä‡§Æ‡§æ ‡§∂‡§¨‡•ç‡§¶ ‡§™‡•Ç‡§õ‡•á‡§Ç, ‡§Ø‡§æ ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∂ ‡§™‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è '‡§™‡•â‡§≤‡§ø‡§∏‡•Ä ‡§¢‡•Ç‡§Ç‡§¢‡•ã' ‡§ï‡§π‡•á‡§Ç‡•§",
                'mr-IN': "‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! üôè ‡§Æ‡§≤‡§æ ‡§è‡§ñ‡§æ‡§¶‡§æ ‡§∂‡§¨‡•ç‡§¶ ‡§∏‡§Æ‡§ú‡§æ‡§µ‡•Ç‡§® ‡§∏‡§æ‡§Ç‡§ó‡§æ, ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§∂‡§ø‡§´‡§æ‡§∞‡§∂‡•Ä‡§∏‡§æ‡§†‡•Ä '‡§™‡•â‡§≤‡§ø‡§∏‡•Ä ‡§∂‡•ã‡§ß‡§æ' ‡§Æ‡•ç‡§π‡§£‡§æ‡•§",
                 // Add all other welcome messages here
            };
            chatBox.innerHTML = ''; appendMessage(messages[lang] || messages['en-IN'], 'bot-message');
        }

        languageSelector.addEventListener('change', async (event) => {
            const selectedLang = event.target.value; setWelcomeMessage(selectedLang);
            const langCode = selectedLang.split('-')[0];
            await fetch('/set-language', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ language: langCode })
            });
        });

        function handleKeyPress(e) { if (e.key === "Enter") sendMessage(); }

        window.onload = async () => {
            const initialLang = languageSelector.value; setWelcomeMessage(initialLang);
            const langCode = initialLang.split('-')[0];
            await fetch('/set-language', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ language: langCode })
            });
        };
    </script>
</body>
</html>