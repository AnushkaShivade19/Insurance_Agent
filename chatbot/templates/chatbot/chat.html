{% extends 'base.html' %}
{% load static %}

{% block title %}Chat - BimaSakhi{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'chatbot/css/chat.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styling for the Language Dropdown */
        .language-select {
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #4f46e5;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
            max-width: 150px;
        }
        .language-select:hover {
            border-color: #4f46e5;
        }
    </style>
{% endblock %}

{% block content %}
<div class="chat-page-container">
    
    <div class="visual-sakhi-container">
        <div class="sakhi-avatar-wrapper">
            <div class="sakhi-circle" id="sakhiAvatar">
                <img src="https://cdn-icons-png.flaticon.com/512/4140/4140047.png" alt="BimaSakhi" class="sakhi-img">
                <div class="speaking-ring"></div>
                <div class="speaking-ring delay"></div>
            </div>
            
            <div class="sakhi-status">
                <h3>BimaSakhi</h3>
                <p><span class="dot"></span> Online & Listening</p>
            </div>
        </div>
        
        <div class="quick-tips">
            <h4>üí° Quick Tips:</h4>
            <ul>
                <li>"Help me find a plan"</li>
                <li>"What is Term Insurance?"</li>
                <li>"How to file a claim?"</li>
            </ul>
        </div>
    </div>

    <div class="chat-wrapper">
        <div class="chat-container">
            
            <div class="header-controls">
                <div class="header-title">
                    <i data-feather="message-square" style="color: #4f46e5;"></i>
                    <span style="margin-left: 10px;">Live Chat</span>
                </div>

                <div>
                    <select id="languageSelect" class="language-select" onchange="changeLanguage()">
                        <option value="en" {% if request.session.language == 'en' %}selected{% endif %}>English</option>
                        <option value="hi" {% if request.session.language == 'hi' %}selected{% endif %}>Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                        <option value="mr" {% if request.session.language == 'mr' %}selected{% endif %}>Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
                        <option value="gu" {% if request.session.language == 'gu' %}selected{% endif %}>Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
                        <option value="bn" {% if request.session.language == 'bn' %}selected{% endif %}>Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
                        <option value="ta" {% if request.session.language == 'ta' %}selected{% endif %}>Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                        <option value="te" {% if request.session.language == 'te' %}selected{% endif %}>Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                        <option value="kn" {% if request.session.language == 'kn' %}selected{% endif %}>Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
                        <option value="ml" {% if request.session.language == 'ml' %}selected{% endif %}>Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
                        <option value="pa" {% if request.session.language == 'pa' %}selected{% endif %}>Punjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
                    </select>
                </div>
            </div>

            <div class="chat-box" id="chatBox"></div>

            <div class="input-area">
                <input id="userInput" placeholder="Ask BimaSakhi..." autocomplete="off">
                
                <button id="mic-btn" class="mic-button" title="Voice Input">
                    <i data-feather="mic"></i>
                </button>
                
                <button onclick="sendMessage()" class="send-button" title="Send Message">
                    <i data-feather="send"></i>
                </button>
            </div>

            <div id="chat-config" 
                 data-api-url="{% url 'get_response' %}" 
                 data-speak-url="{% url 'speak_text' %}"
                 data-set-lang-url="{% url 'set_language' %}"
                 data-csrf="{{ csrf_token }}"
                 data-context="{{ request.GET.context|default:'' }}">
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'chatbot/js/chat.js' %}?v=9.2"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // 1. Initialize Icons
            feather.replace();
            
            // 2. Enable "Enter" key to send message
            const inputField = document.getElementById("userInput");
            if (inputField) {
                inputField.addEventListener("keypress", function(event) {
                    if (event.key === "Enter") {
                        event.preventDefault(); 
                        sendMessage(); 
                    }
                });
            }
        });

        // --- LANGUAGE CHANGE LOGIC ---
        function changeLanguage() {
            const langCode = document.getElementById('languageSelect').value;
            const csrfToken = document.getElementById('chat-config').dataset.csrf;
            const url = document.getElementById('chat-config').dataset.setLangUrl;

            // Call Django backend to update session
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ language: langCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log("Language updated to:", langCode);
                    // Optional: Visual feedback (e.g., change input placeholder)
                    const input = document.getElementById('userInput');
                    if (langCode === 'hi') input.placeholder = "‡§¨‡•Ä‡§Æ‡§æ ‡§∏‡§ñ‡•Ä ‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç...";
                    else if (langCode === 'mr') input.placeholder = "‡§µ‡§ø‡§Æ‡§æ ‡§∏‡§ñ‡•Ä‡§≤‡§æ ‡§µ‡§ø‡§ö‡§æ‡§∞‡§æ...";
                    else input.placeholder = "Ask BimaSakhi...";
                }
            })
            .catch(error => console.error('Error changing language:', error));
        }
    </script>
{% endblock %}
